# GitLab Merge Request Creation and Response Posting

This document explains how the webhook-triggered Claude Code execution handles different scenarios after processing tasks in GitLab pipelines.

## Overview

After Claude Code executes in a webhook-triggered pipeline, the system automatically detects whether any code changes were made and takes appropriate action:

1. **With Code Changes**: Creates a merge request with the changes
2. **Without Code Changes**: Posts Claude's response as a comment on the original issue/MR

## Webhook-Triggered Execution Flow

### Initial Setup

1. User mentions @claude in an issue or merge request comment
2. Webhook server receives GitLab webhook event
3. Server validates webhook, applies rate limiting, and creates branch (for issues)
4. Server triggers GitLab CI/CD pipeline with environment variables
5. Pipeline executes Claude Code using the unified entrypoint

### Environment Context

The webhook server provides comprehensive context to the pipeline:

```bash
# Webhook-provided environment variables
CLAUDE_TRIGGER=true                    # Indicates webhook trigger
CLAUDE_AUTHOR=username                 # User who mentioned @claude
CLAUDE_RESOURCE_TYPE=issue             # "issue" or "merge_request"
CLAUDE_RESOURCE_ID=123                 # Issue/MR IID
CLAUDE_NOTE=@claude please help        # Full comment text
DIRECT_PROMPT=please help              # Text after @claude
CLAUDE_PROJECT_PATH=group/project      # Project namespace/path
```

## Scenarios

### 1. Code Changes Detected (Issue Comments)

When Claude modifies files during execution from an issue comment:

1. **Branch Creation**: Webhook server creates branch with format `claude/issue-{IID}-{sanitized-title}-{timestamp}`
2. **Code Execution**: Claude makes changes to files in the created branch
3. **Commit**: Changes are committed with a descriptive message
4. **Merge Request Creation**: System automatically creates an MR using GitLab push options:

   ```bash
   git push \
     -o merge_request.create \
     -o merge_request.target=main \
     -o merge_request.title="Apply Claude's suggestions for issue #${CLAUDE_RESOURCE_ID}" \
     -o merge_request.description="..." \
     -o merge_request.remove_source_branch \
     origin claude/issue-${CLAUDE_RESOURCE_ID}-${timestamp}
   ```

5. **Comment Update**: A comment is posted on the original issue with a link to the new MR

Example MR created by Claude:

```
Title: Apply Claude's suggestions for issue #42

Description:
This merge request was automatically created by Claude AI via webhook trigger.

**Original issue**: https://gitlab.com/project/-/issues/42
**Triggered by**: @username
**Claude's task**: Applied automated fixes and improvements as requested.

**Original request**: @claude please help with the bug

/cc @username
```

### 2. Code Changes Detected (Merge Request Comments)

When Claude modifies files during execution from an MR comment:

1. **Existing Branch**: Uses the MR's source branch (no new branch creation)
2. **Code Execution**: Claude makes changes directly to the MR branch
3. **Commit**: Changes are committed to the existing MR branch
4. **Comment Update**: Updates the original MR comment with execution results

### 3. No Code Changes

When Claude provides analysis or suggestions without modifying code:

1. **Extract Response**: Claude's response is extracted from the execution output
2. **Format Message**: The response is formatted with markdown
3. **Post Comment**: The formatted response is posted as a comment on the original issue/MR

Example comment:

```markdown
## ü§ñ Claude's Response

Based on my analysis of your codebase, I found the following issues...

[Claude's full response here]

---

_This response was generated by Claude AI via webhook trigger. No code changes were made._
```

## Configuration

### GitLab CI/CD Pipeline

The webhook-triggered pipeline uses the unified entrypoint:

```yaml
workflow:
  rules:
    - if: $CLAUDE_TRIGGER == "true"

claude:
  stage: claude
  image: oven/bun:1.1.29-alpine
  before_script:
    - apk add --no-cache git curl
    - git config --global user.name "Claude[bot]"
    - git config --global user.email "claude-bot@noreply.gitlab.com"
    - git clone https://github.com/hyperremix/claude-code-for-gitlab.git /tmp/claude-code
    - cd /tmp/claude-code && bun install --frozen-lockfile
  script:
    - cd /tmp/claude-code && bun run src/entrypoints/gitlab_entrypoint.ts
  variables:
    GITLAB_TOKEN: $CLAUDE_CODE_GL_ACCESS_TOKEN
    CLAUDE_CODE_OAUTH_TOKEN: $CLAUDE_CODE_OAUTH_TOKEN
  timeout: 30m
  interruptible: true
```

### Environment Variables

The following GitLab CI variables are used:

- `GITLAB_TOKEN` / `CLAUDE_CODE_GL_ACCESS_TOKEN`: For GitLab API authentication
- `CLAUDE_CODE_OAUTH_TOKEN` / `ANTHROPIC_API_KEY`: For Claude API authentication
- `CI_JOB_TOKEN`: For git authentication (automatically provided by GitLab)
- `CI_SERVER_HOST`: GitLab server hostname
- `CI_PROJECT_PATH`: Project path (namespace/project)
- `CI_DEFAULT_BRANCH`: Target branch for MRs (defaults to "main")

### Git Configuration

The system automatically configures git with:

```bash
git config --global user.name "Claude[bot]"
git config --global user.email "claude-bot@noreply.gitlab.com"
```

## Implementation Details

The logic is implemented in `src/entrypoints/gitlab_entrypoint.ts`:

### Core Functions

1. **`runPreparePhase()`**: Sets up context and validates webhook trigger
2. **`runExecutePhase()`**: Executes Claude Code with provided context
3. **`runUpdatePhase()`**: Handles result processing and posting
4. **`checkGitStatus()`**: Checks if there are any uncommitted changes
5. **`createMergeRequest()`**: Handles branch creation, commit, and MR creation
6. **`postClaudeResponse()`**: Extracts and posts Claude's response when no changes exist

### Decision Logic

```typescript
// Simplified decision flow in runUpdatePhase()
const hasChanges = await checkGitStatus();

if (hasChanges) {
  // Create MR with changes
  await createMergeRequest();
  await updateTrackingComment("MR created with Claude's changes");
} else {
  // Post response as comment
  await postClaudeResponse();
  await updateTrackingComment("Claude's analysis posted");
}
```

## Branch Management

### Automatic Branch Creation (Issues)

The webhook server creates branches for issue comments:

1. **Format**: `claude/issue-{IID}-{sanitized-title}-{timestamp}`
2. **Base Branch**: Always created from the default branch (main/master)
3. **Unique Names**: Timestamp ensures no conflicts
4. **Safety**: Never executes on protected branches

### Existing Branch Usage (Merge Requests)

For MR comments, Claude uses the existing MR branch:

1. **Direct Commits**: Pushes changes to the MR's source branch
2. **No New Branches**: Avoids branch proliferation
3. **Immediate Updates**: Changes appear directly in the MR diff

## Error Handling

### Common Error Scenarios

**MR Creation Failures**:

- If MR creation fails, the error is logged but doesn't fail the job
- Comment is updated with error information and manual MR creation link

**Comment Posting Failures**:

- If response posting fails, it's logged as a warning
- Tracking comment is always updated regardless of the outcome

**Authentication Issues**:

- Token validation occurs during preparation phase
- Clear error messages guide users to fix token configuration

**Branch Permission Issues**:

- Webhook server validates branch creation before triggering pipeline
- Pipeline fails safely if branch operations are not permitted

### Error Recovery

```typescript
// Error handling example
try {
  await createMergeRequest();
  await updateComment("‚úÖ Merge request created successfully");
} catch (error) {
  console.error("MR creation failed:", error);
  await updateComment("‚ùå Could not create MR automatically. Please create manually.");
}
```

## Security Considerations

### Authentication

- Uses GitLab CI/CD tokens for git operations (`CI_JOB_TOKEN`)
- Uses personal access tokens for API operations (`CLAUDE_CODE_GL_ACCESS_TOKEN`)
- No long-lived tokens are stored or exposed in git history

### Permissions

- Webhook server validates user permissions before triggering
- Pipeline inherits permissions from the webhook server's GitLab token
- Branch protection rules are respected (Claude never pushes to protected branches)

### Audit Trail

- All MRs created by Claude are clearly marked as AI-generated
- Original issue/MR context is preserved in MR descriptions
- User who triggered Claude is credited in MR descriptions

## Monitoring and Debugging

### Pipeline Logs

Key log sections to monitor:

```bash
# Webhook trigger validation
=== Webhook Environment Variables ===
CLAUDE_TRIGGER: true
CLAUDE_RESOURCE_TYPE: issue

# Git status check
=== Git Status Check ===
Changes detected: true/false

# Result processing
=== Result Processing ===
Creating merge request...
MR created: https://gitlab.com/project/-/merge_requests/123
```

### Common Issues

**MRs not being created**:

1. Check if changes were actually made (`git status` in logs)
2. Verify GitLab token has `write_repository` scope
3. Check branch protection rules

**Comments not posting**:

1. Verify GitLab token has `api` scope
2. Check if user has permission to comment on the resource
3. Review API rate limits

**Branch conflicts**:

1. Webhook server uses timestamps to prevent conflicts
2. If conflicts occur, check webhook server logs for branch creation issues

## Best Practices

### Pipeline Configuration

1. **Use interruptible jobs**: Allow cancellation of long-running Claude executions
2. **Set appropriate timeouts**: Default 30 minutes, adjust based on your needs
3. **Cache dependencies**: Cache node_modules for faster subsequent runs
4. **Monitor resource usage**: Track pipeline duration and costs

### Error Handling

1. **Graceful degradation**: Always update tracking comments even if MR creation fails
2. **Clear error messages**: Provide actionable error information to users
3. **Fail safely**: Don't leave pipelines in hanging state due to API failures

### Security

1. **Token rotation**: Regularly rotate GitLab personal access tokens
2. **Scope limitation**: Use minimal required token scopes
3. **Audit logging**: Monitor webhook triggers and pipeline executions
4. **Branch protection**: Use GitLab branch protection rules appropriately

## Migration Notes

### From Direct CI/CD Execution

If migrating from the old direct CI/CD approach:

1. **Remove old configurations**: Delete `gitlab-claude-complete.yml` references
2. **Update pipeline configuration**: Use webhook-triggered configuration above
3. **Deploy webhook server**: Set up the webhook server as described in [setup guide](GITLAB_APP_SETUP.md)
4. **Test thoroughly**: Verify MR creation and comment posting work correctly

### Environment Variable Changes

New webhook-based environment variables:

- `CLAUDE_TRIGGER` replaces manual trigger detection
- `CLAUDE_RESOURCE_TYPE` and `CLAUDE_RESOURCE_ID` provide specific context
- `DIRECT_PROMPT` contains the text after @claude mention
- Webhook server handles branch creation instead of pipeline logic

## Support

For MR creation and response posting issues:

- Review GitLab CI/CD pipeline logs for detailed execution information
- Check webhook server logs for trigger and branch creation events
- Verify GitLab token permissions and scopes
- Test webhook delivery in GitLab project settings
- Monitor rate limiting and authentication status in both webhook server and pipeline logs
